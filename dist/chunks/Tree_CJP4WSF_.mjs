import { c as createComponent, m as maybeRenderHead, u as unescapeHTML, r as renderTemplate } from './astro/server_BWQ42mf1.mjs';
import 'kleur/colors';
import 'clsx';

const html = () => "<hr>\n<section><h1 id=\"dfs-序\">dfs 序<a class=\"anchor\" href=\"#dfs-序\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>对于一棵树，我们从根节点处开始 dfs，过程中在每个点第一次遇到的时候把它记录下来，就得到了一棵树的 dfs 序，一般记作 dfn。</p><p>它有一个优势在于一棵子树中的节点在 dfs 序上是连续的，这可以帮我们解决很多子树修改、子树查询问题。</p><hr><section><h2 id=\"例题\">例题：<a class=\"anchor\" href=\"#例题\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2></section><section><h2 id=\"子树加子树求和\">子树加子树求和<a class=\"anchor\" href=\"#子树加子树求和\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个节点的树，以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 为根，初始时所有点的点权均为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 次操作，每次操作给出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">u,x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>，你需要给子树 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 中的所有点点权都加上 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>，然后输出子树 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 的点权和。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator=\"true\">,</mo><mi>q</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">1\\le n,q\\le 5\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>求出树的 dfn 后该问题就变成了区间加、区间求和问题，线段树维护即可。</p><hr></section><section><h2 id=\"nearest-leaf\"><a href=\"https://www.luogu.com.cn/problem/CF1110F\">Nearest Leaf</a><a class=\"anchor\" href=\"#nearest-leaf\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2600</mn></mrow><annotation encoding=\"application/x-tex\">2600</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2600</span></span></span></span></p><p>给定一棵树，边有边权，保证其有一种 dfn 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mn>3</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">1,2,3,\\dots ,n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>。</p><p>保证 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 号节点不是叶子。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 次询问，每次给定 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>l</mi><mo separator=\"true\">,</mo><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">x,l,r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span>，你需要求出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><mrow><mi>i</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mi>l</mi><mo separator=\"true\">,</mo><mi>r</mi><mo stretchy=\"false\">]</mo><mo separator=\"true\">,</mo><mi>i</mi><mtext>是叶子</mtext></mrow></munder><mi>d</mi><mi>i</mi><mi>s</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\min\\limits_{i\\in [l,r],i \\text{是叶子}}dis(x,i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.716em;vertical-align:-0.966em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6679em;\"><span style=\"top:-2.309em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">∈</span><span class=\"mopen mtight\">[</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mclose mtight\">]</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord text mtight\"><span class=\"mord cjk_fallback mtight\">是叶子</span></span></span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span><span class=\"mop\">min</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.966em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> 。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mi>m</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">3\\le n\\le 5\\times10^5,1\\le m\\le 5\\times 10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>考虑一个弱化的问题：如果查询的始终是根节点，那么我们只需求出每个点到根节点的距离，然后查询就变成了一个区间最小值问题。</p><p>回到原题，此处涉及一个换根的问题，如果要把根节点换成一个相邻的节点，经过一条长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span> 的边到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span>，那么每个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 子树内的点，它到根的距离会减少 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span>，其余节点到根的距离会增加 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span>，这就是一个子树加减的操作，所以直接用线段树维护子树加，子树最小值即可。</p><hr></section></section>\n<section><h1 id=\"欧拉序\">欧拉序<a class=\"anchor\" href=\"#欧拉序\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>在上述 dfs 的过程中，每次进入一个节点就把它记下来，得到的长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo stretchy=\"false\">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">2(n-1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">2</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 的序列为欧拉序。</p><p>如果把欧拉序首尾拼接可以得到一个环，选择不同的断点可以得到不同的根下所得的欧拉序，所以欧拉序的换根是方便的。</p><hr></section>\n<section><h1 id=\"最近公共祖先\">最近公共祖先<a class=\"anchor\" href=\"#最近公共祖先\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 的公共祖先中深度最大的节点被称为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 的最近公共祖先，一般记作 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}(u,v)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>在欧拉序中，设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 最早出现的位置分别为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>u</mi></msub><mo separator=\"true\">,</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">idx_u,idx_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，不妨设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>u</mi></msub><mo>≤</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">idx_u\\le idx_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，那么它们的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 一定出现在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>u</mi></msub><mo separator=\"true\">,</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>v</mi></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[idx_u,idx_v]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> 中，而更浅的祖先不会，所以这就转化为了一个区间最小值问题，可以配合 ST 表做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 求 LCA。</p><p>在 dfn 中，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>u</mi></msub><mo separator=\"true\">,</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>v</mi></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[idx_u,idx_v]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> 中一定会出现它们 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 的一个子节点，那么我们也只需求出区间最小值，然后返回它的父亲节点即可，注意要特判 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 子树中的情况，或者，你也可以询问 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>u</mi></msub><mo>+</mo><mn>1</mn><mo separator=\"true\">,</mo><mi>i</mi><mi>d</mi><msub><mi>x</mi><mi>v</mi></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">[idx_u+1,idx_v]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> 中的最小值，这样只需要特判 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo>=</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u=v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 就可以。</p><hr><p>考虑对于每个节点，我们预处理出他的所有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8491em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span></span></span></span> 级节点。</p><p>对于两个相同深度的节点，我们可以将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">\\log_2n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9386em;vertical-align:-0.2441em;\"></span><span class=\"mop\"><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.207em;\"><span style=\"top:-2.4559em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2441em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 起依次减少，每次判断 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8491em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span></span></span></span> 级祖先是否相同，如果不同，则将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 同时跳到它们的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>k</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8491em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span></span></span></span></span></span></span></span> 级祖先，最后再求出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 两者的父亲即可。</p><p>对于两个深度不同的节点，我们可以先将深度较大的节点向上跳到和另一节点同一高度，然后再用上面的做法。</p><p>这个做法是单 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>log</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\log</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span></span></span></span> 的。</p><hr><section><h2 id=\"company\"><a href=\"https://www.luogu.com.cn/problem/CF1062E\">Company</a><a class=\"anchor\" href=\"#company\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2300</mn></mrow><annotation encoding=\"application/x-tex\">2300</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2300</span></span></span></span></p><p>给定一颗树，有若干个询问，每个询问给出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span>，要求编号为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mo>∼</mo><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">l\\sim r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 的点任意删去一个之后剩余点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 深度最大，输出删去点的编号和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 的最大深度。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mi>q</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">2\\le n\\le10^5,1\\le q\\le 10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><p>可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo>+</mo><mi>q</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n+q)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>考虑区间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 怎么求，可以用 st 表或线段树维护，这样的预处理时间复杂度是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><msup><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msup><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log^2n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1484em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\"><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8984em;\"><span style=\"top:-3.1473em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 的。</p><p>但是这个区间的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 实际上等于其中在 dfn 中的 idx 最大、最小的两个节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span>，可以用 dfn 求 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{lca}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">lca</span></span></span></span></span> 的方法直接证明。</p><p>所以可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 预处理，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 查询。</p><p>那么题目中的去掉一个点就是去掉 idx 最大或最小的点，简单分讨即可。</p><hr></section></section>\n<section><h1 id=\"树上距离\">树上距离<a class=\"anchor\" href=\"#树上距离\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>一般定义树上两点之间的唯一一条简单路径的长度为这两点之间的距离。</p><p>不妨设每个点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 到根的距离为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">dep_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 之间的距离为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>u</mi></msub><mo>+</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>v</mi></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow></msub></mrow><annotation encoding=\"application/x-tex\">dep_u+dep_v-2dep_{\\operatorname{lca}(u,v)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0496em;vertical-align:-0.3552em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mop mtight\"><span class=\"mord mathrm mtight\">lca</span></span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span></span></span></span>，可以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 求出。</p><hr></section>\n<section><h1 id=\"树的直径\">树的直径<a class=\"anchor\" href=\"#树的直径\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>（以下的讨论建立于树的边权均为非负数的情况）</p><p>树上最长的链为这棵树的直径，直径可以有多条。</p><p>在前面已经讲了一个换根，维护所有点到根的距离的方式，显然可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 求直径，但是，还能再强一点吗？</p><hr><p>不妨让我们先发现一下直径的性质，我们可以发现：</p><p>对于每个节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span>，以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 为一端的最长链另一端一定是直径的一端，否则可以考虑把这条链的另一端接到直径上去。</p><hr><p>于是我们可以得到一个极简做法：</p><p>随便找一个点，求出离它最远的点，这个点即直径的一个端点。</p><p>然后再求出离这个端点最远的一个点，就是直径的另一个端点。</p><p>时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>当然，也不难想到一个 dp 做法，即对于每一个节点，求出它跟子树内离它最远的点之间的距离，然后把两条拼接成一条，不难得到直径，时间复杂度也是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 的。</p><hr><p>或者，我们考虑一条路径的长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>u</mi></msub><mo>+</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>v</mi></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mrow><mi mathvariant=\"normal\">lca</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow></msub></mrow><annotation encoding=\"application/x-tex\">dep_u+dep_v-2dep_{\\operatorname{lca}(u,v)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0496em;vertical-align:-0.3552em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.5198em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mop mtight\"><span class=\"mord mathrm mtight\">lca</span></span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3552em;\"><span></span></span></span></span></span></span></span></span></span>，在欧拉序上，我们只需找到三个位置 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi><mo>≤</mo><mi>q</mi><mo>≤</mo><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">p\\le q\\le r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span>，使得 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>p</mi></msub><mo>+</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>r</mi></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>q</mi></msub></mrow><annotation encoding=\"application/x-tex\">dep_p+dep_r-2dep_q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">q</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 最大即可，可以转化为欧拉序上 dp。</p><hr><section><h2 id=\"例题区间直径\">例题：区间直径<a class=\"anchor\" href=\"#例题区间直径\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>给定一棵树，设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">dis</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\operatorname{dis}(x,y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">dis</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x,y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 在树上的距离。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 次询问，每次给出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mo separator=\"true\">,</mo><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">l,r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span>，求：</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>l</mi><mo>≤</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo>≤</mo><mi>r</mi></mrow></msub><mi mathvariant=\"normal\">dis</mi><mo>⁡</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\max_{l\\le x,y\\le r}\\operatorname{dis}(x,y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\"></span><span class=\"mop\"><span class=\"mop\">max</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">dis</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span></p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>2</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mi>q</mi><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup></mrow><annotation encoding=\"application/x-tex\">1\\le n\\le 2\\times10^5,1\\le q\\le 10^6</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">6</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>直径是可合并的，如果两个点集中的直径分别为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><mi>p</mi><mo separator=\"true\">,</mo><mi>q</mi><mo stretchy=\"false\">}</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">{</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{p,q\\},\\{u,v\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord mathnormal\">p</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mclose\">}</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mopen\">{</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">}</span></span></span></span>，那么两个点集的并集的直径两个端点必定是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi><mo separator=\"true\">,</mo><mi>q</mi><mo separator=\"true\">,</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">p,q,u,v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 中的两个，凭借这个性质，我们可以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 合并两个点集的直径。</p><p>结合 ST 表可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 预处理，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 查询区间直径。</p><hr></section><section><h2 id=\"dynamic-diameter\"><a href=\"https://www.luogu.com.cn/problem/CF1192B\">Dynamic</a><a href=\"https://www.luogu.com.cn/problem/P6845\"> Diameter</a><a class=\"anchor\" href=\"#dynamic-diameter\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>有一棵树，含 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个节点，边带权。</p><p>会有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 次修改，每次会将树上的一条边的边权进行修改，在每次修改后，您需要求出这棵树的直径长度。</p><p><strong>强制在线。</strong></p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator=\"true\">,</mo><mi>q</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">1\\le n,q\\le10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>优化欧拉序上 dp，用线段树维护以下几个值：</p><ul>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mi>l</mi><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>r</mi></mrow></msub><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\max_{l\\le x\\le r} dep_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9396em;vertical-align:-0.2452em;\"></span><span class=\"mop\"><span class=\"mop\">max</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2452em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>min</mi><mo>⁡</mo></mrow><mrow><mi>l</mi><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>r</mi></mrow></msub><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\min_{l\\le x\\le r} dep_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9396em;vertical-align:-0.2452em;\"></span><span class=\"mop\"><span class=\"mop\">min</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2452em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>y</mi><mo>≤</mo><mi>r</mi></mrow></msub><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\max_{1\\le x\\le y\\le r} dep_x-2dep_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mop\"><span class=\"mop\">max</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>y</mi><mo>≤</mo><mi>r</mi></mrow></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub><mo>+</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\max_{1\\le x\\le y\\le r} -2dep_x+dep_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mop\"><span class=\"mop\">max</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">−</span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mrow><mn>1</mn><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>y</mi><mo>≤</mo><mi>z</mi><mo>≤</mo><mi>r</mi></mrow></msub><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub><mo>−</mo><mn>2</mn><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>y</mi></msub><mo>+</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>z</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\max_{1\\le x\\le y\\le z\\le r} dep_x-2dep_y+dep_z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mop\"><span class=\"mop\">max</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\">x</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span><span class=\"mrel mtight\">≤</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.04398em;\">z</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></li>\n</ul><p>维护一个区间加的操作即可。</p><hr><p>很多题目都会出现最长链等关键词，通常这些题目都要用到直径有关的性质。</p><hr></section><section><h2 id=\"roads-and-ramen\"><a href=\"https://www.luogu.com.cn/problem/CF1413F\">Roads and Ramen</a><a class=\"anchor\" href=\"#roads-and-ramen\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2800</mn></mrow><annotation encoding=\"application/x-tex\">2800</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2800</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的树，每条边上有权值 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi mathvariant=\"normal\">/</mi><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">0/1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0/1</span></span></span></span>，定义路径的长度为路径上边的数量。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 次修改，每次修改会修改一条边的权值，每次修改后回答最长的有偶数个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 的路径长度。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mi>q</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">2\\le n\\le 5\\times10^5,1\\le q\\le 5\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>随意定一个根，令点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 到根路径上边权异或和为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，那么一条路径 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{x,y\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">}</span></span></span></span> 上有偶数个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 当且仅当 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>x</mi></msub><mo>=</mo><msub><mi>s</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_x=s_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>。</p><p>对于直径 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><mi>p</mi><mo separator=\"true\">,</mo><mi>q</mi><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{p,q\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord mathnormal\">p</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mclose\">}</span></span></span></span>，如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>p</mi></msub><mo>=</mo><msub><mi>s</mi><mi>q</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_p=s_q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">q</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>，那么答案显然就是直径的长度。</p><p>否则，对于任意一个点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span>，由于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>p</mi></msub><mo mathvariant=\"normal\">≠</mo><msub><mi>s</mi><mi>q</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_p\\neq s_q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\"><span class=\"mrel\"><span class=\"mord vbox\"><span class=\"thinbox\"><span class=\"rlap\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"inner\"><span class=\"mord\"><span class=\"mrel\"></span></span></span><span class=\"fix\"></span></span></span></span></span><span class=\"mrel\">=</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">q</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>，则必有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>u</mi></msub><mo>=</mo><msub><mi>s</mi><mi>p</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_u=s_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>s</mi><mi>u</mi></msub><mo>=</mo><msub><mi>s</mi><mi>q</mi></msub></mrow><annotation encoding=\"application/x-tex\">s_u=s_q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">q</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>，所以答案的链的一个端点一定是直径的一个端点。</p><p>用线段树维护区间 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi mathvariant=\"normal\">/</mi><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">0/1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0/1</span></span></span></span> 翻转即可动态维护最长直链，以直径两端为根分别做一遍即可。</p><p>时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo>+</mo><mi>q</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n+q\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr></section></section>\n<section><h1 id=\"树的中心\">树的中心<a class=\"anchor\" href=\"#树的中心\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>对于一个节点，如果所有节点到它距离的最大值取到最小值，那么这个节点就是树的中心。</p><p>树的中心可以直接考虑求出树的直径，然后找到直径中点即可，时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><section><h2 id=\"tree-compass\"><a href=\"https://www.luogu.com.cn/problem/CF1943C\">Tree Compass</a><a class=\"anchor\" href=\"#tree-compass\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2300</mn></mrow><annotation encoding=\"application/x-tex\">2300</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2300</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的树，初始时所有点都是白色的，每次你可以选择一个点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 和一个非负整数半径 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span>，将树上所有与 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 距离为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span> 的点染成黑色，求把所有点染成黑色的最少操作次数，并给出一组方案。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>2</mn><mo>×</mo><msup><mn>10</mn><mn>3</mn></msup></mrow><annotation encoding=\"application/x-tex\">1\\le n\\le2\\times10^3</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span></span></span></span></p><p>可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>求出树的直径和中点，设直径长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span>。</p><p>如果 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span> 为奇数：</p><p>此时有一个中心，对于这个中心操作 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌈</mo><mfrac><mi>l</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌉</mo></mrow><annotation encoding=\"application/x-tex\">\\lceil\\frac{l}{2}\\rceil</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2251em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌈</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8801em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌉</span></span></span></span> 次，可以证明是最优方案。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">l</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span> 为偶数时有两个中心，同理操作即可。</p><hr></section></section>\n<section><h1 id=\"树的重心\">树的重心<a class=\"anchor\" href=\"#树的重心\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>对于一个节点，如果删掉这个节点后，所有连通块大小的最大值取到最小值，那么这个节点就是树的重心。</p><hr><p>树的重心有一系列性质：</p><ul>\n<li>树的重心如果不唯一，则至多有两个，且这两个重心相邻。</li>\n<li>以树的重心为根时，所有子树的大小都不超过整棵树大小的一半。</li>\n<li>树中所有点到某个点的距离和中，到重心的距离和是最小的；如果有两个重心，那么到它们的距离和一样。</li>\n<li>把两棵树通过一条边相连得到一棵新的树，那么新的树的重心在连接原来两棵树的重心的路径上。</li>\n<li>在一棵树上添加或删除一个叶子，那么它的重心最多只移动一条边的距离。</li>\n</ul><hr><p>通过以上性质可以推得：设子树 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 的大小为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>i</mi><msub><mi>z</mi><mi>u</mi></msub></mrow><annotation encoding=\"application/x-tex\">siz_u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8095em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.044em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 的子节点中的最大子树大小为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><msub><mi>x</mi><mi>u</mi></msub></mrow><annotation encoding=\"application/x-tex\">mx_u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，则如果某个节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 满足 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>−</mo><mi>s</mi><mi>i</mi><msub><mi>z</mi><mi>u</mi></msub><mo>≤</mo><mfrac><mi>n</mi><mn>2</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">n-siz_u\\le \\frac{n}{2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8095em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.044em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0404em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span> 且 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><msub><mi>x</mi><mi>u</mi></msub><mo>≤</mo><mfrac><mi>n</mi><mn>2</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">mx_u\\le\\frac{n}{2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.786em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0404em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，那么这个节点就是重心，即 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>m</mi><msub><mi>x</mi><mi>u</mi></msub><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>2</mn><mi>s</mi><mi>i</mi><msub><mi>z</mi><mi>u</mi></msub></mrow><annotation encoding=\"application/x-tex\">2mx_u\\le n\\le 2siz_u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7944em;vertical-align:-0.15em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8095em;vertical-align:-0.15em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.044em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</p><p>通过上述性质可以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 求出重心。</p><hr><section><h2 id=\"例题kay-and-snowflake\">例题：<a href=\"https://www.luogu.com.cn/problem/CF685B\">Kay and Snowflake</a><a class=\"anchor\" href=\"#例题kay-and-snowflake\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个节点的树，求每个子树的重心。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">2\\le n\\le 3\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><p>可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>我们称一个节点的所有儿子中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>i</mi><mi>z</mi></mrow><annotation encoding=\"application/x-tex\">siz</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span></span></span></span> 最大的节点为它的重儿子，其它的为轻儿子。</p><p>发现对于子树 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span>，它的重心不可能在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 的轻儿子的子树。</p><p>设重儿子为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span>，子树 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span> 的重心为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>e</mi><mi>n</mi><msub><mi>t</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">cent_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7651em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">ce</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，那么 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>e</mi><mi>n</mi><msub><mi>t</mi><mi>u</mi></msub></mrow><annotation encoding=\"application/x-tex\">cent_u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7651em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">ce</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 一定在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi></mrow><annotation encoding=\"application/x-tex\">u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">u</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>e</mi><mi>n</mi><msub><mi>t</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">cent_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7651em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">ce</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的路径上，因为除了这些点以外的点为根的子树大小都小于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>s</mi><mi>i</mi><msub><mi>z</mi><mi>u</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\frac{1}{2}siz_u</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1901em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8451em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.044em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>。</p><p>所以直接从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>e</mi><mi>n</mi><msub><mi>t</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">cent_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7651em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">ce</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 开始往上跳即可，每个点最多被跳到一次，所以是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 的。</p><hr></section><section><h2 id=\"csp-s2019-树的重心\"><a href=\"https://www.luogu.com.cn/problem/P5666\">[CSP-S2019] 树的重心</a><a class=\"anchor\" href=\"#csp-s2019-树的重心\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>求对于每条边，删除这条边后产生的两棵树的重心编号和之和，若有多个重心则全都计算。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>7</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo>−</mo><mn>5</mn></mrow><annotation encoding=\"application/x-tex\">7\\le n\\le 3\\times10^5-5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">7</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">5</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 为奇数。</p><p>可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>通过上一题的做法，我们可以求出每个子树的重心，那么接下来还需考虑去掉每个子树后的重心。</p><p>如果删掉的边不在重子树内，那么原来的重心只会不断走向重儿子，显然删的子树越大跳的越多，把那些子树大小桶排之后直接从重心开始跳即可。</p><p>否则，重心不断向根节点的次重节点移动，同理维护即可。</p><p>需要处理两个重心的细节，时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr></section></section>\n<section><h1 id=\"dfs-生成树\">dfs 生成树<a class=\"anchor\" href=\"#dfs-生成树\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>我们对一个图进行 dfs，每一个点搜到后就打标记不再搜，保留搜索通过的边，删掉其它的边可以得到一棵 dfs 生成树。</p><hr><p><img src=\"https://oi-wiki.org/graph/images/bcc-1.svg\" alt=\"\"></p><hr><p>可以证明 dfs 生成树没有横跨边，而 bfs 生成树则没有返祖边。</p><p>dfs 生成树没有横跨边的性质非常优秀，这使我们始终能从下往上处理问题。</p><hr><section><h2 id=\"例题choose-your-queries\">例题：<a href=\"https://www.luogu.com.cn/problem/CF2025F\">Choose Your Queries</a><a class=\"anchor\" href=\"#例题choose-your-queries\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2700</mn></mrow><annotation encoding=\"application/x-tex\">2700</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2700</span></span></span></span></p><p>给定长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 的数组 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi></mrow><annotation encoding=\"application/x-tex\">a</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">a</span></span></span></span>，初始全是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> 次操作，每次给出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x,y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>，你必须选择以下两种操作中的一种执行：</p><ul>\n<li>将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 加一。</li>\n<li>将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>a</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">a_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7167em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 减一。</li>\n</ul><p>你需要保证任何时刻，序列中所有数非负，并且最终序列的和最小，求一组方案。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mi>q</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">3\\le n\\le3\\times 10^5,1\\le q\\le3\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8304em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span>，可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo>+</mo><mi>q</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n+q)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>对于二元的条件，很多时候需要使用建图的方式处理。</p><p>对于每对给出的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x,y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>，我们在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 之间连一条边，现在相当于对于每条边都要选一个端点操作，那么对于同一个点，我们一定会交替的选择加一和减一，这样肯定是最优的，那么每次操作相当于选一个点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>01</mn></mrow><annotation encoding=\"application/x-tex\">01</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">01</span></span></span></span> 反转。</p><p>那么我们建出 dfs 生成树，从低往高考虑，对于每个点往上连的所有边，如果这个点是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>，那么就选一条边用来反转他，剩下的所有边都往上反转，否则就直接全都往上反转，由于除了根以外的节点至少有连向父亲的一条边，所以这些点的权值一定是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span>，只有根可能是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>，不难证明此时总和达到了最小值。</p><hr><p>值得注意的是，图不一定是连通的，要对每个连通块跑一遍。</p><hr></section><section><h2 id=\"pairs-of-pairs\"><a href=\"https://www.luogu.com.cn/problem/CF1391E\">Pairs of Pairs</a><a class=\"anchor\" href=\"#pairs-of-pairs\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2600</mn></mrow><annotation encoding=\"application/x-tex\">2600</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2600</span></span></span></span></p><p>给出一张 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">m</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">m</span></span></span></span> 条边的无向简单连通图，选择以下一个任务完成：</p><ul>\n<li>输出一条长度至少为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌈</mo><mfrac><mi>n</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌉</mo></mrow><annotation encoding=\"application/x-tex\">\\lceil\\frac{n}{2}\\rceil</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.095em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌈</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌉</span></span></span></span> 的路径。</li>\n<li>选出偶数个点（至少 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌈</mo><mfrac><mi>n</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌉</mo></mrow><annotation encoding=\"application/x-tex\">\\lceil\\frac{n}{2}\\rceil</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.095em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌈</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌉</span></span></span></span> 个），将它们两两配对，使得每两对中的四个点的导出子图最多有两条边。</li>\n</ul><hr><p>搜出一棵 dfs 生成树，如果有长度大于等于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌈</mo><mfrac><mi>n</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌉</mo></mrow><annotation encoding=\"application/x-tex\">\\lceil\\frac{n}{2}\\rceil</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.095em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌈</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌉</span></span></span></span> 的直链，那么直接输出。</p><p>否则，把每个点按深度归类，将每个深度中的点两两配对，这样每个深度中只有最多一个点没有被配对，而最大深度不超过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌊</mo><mfrac><mi>n</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌋</mo></mrow><annotation encoding=\"application/x-tex\">\\lfloor\\frac{n}{2}\\rfloor</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.095em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌊</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌋</span></span></span></span>，那么就有至少 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">⌈</mo><mfrac><mi>n</mi><mn>2</mn></mfrac><mo stretchy=\"false\">⌉</mo></mrow><annotation encoding=\"application/x-tex\">\\lceil\\frac{n}{2}\\rceil</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.095em;vertical-align:-0.345em;\"></span><span class=\"mopen\">⌈</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6954em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">⌉</span></span></span></span> 个点被配对，而 dfs 生成树没有横跨边，所以每两对中的四个点的导出子图最多有两条边。</p><hr></section></section>\n<section><h1 id=\"树上启发式合并\">树上启发式合并<a class=\"anchor\" href=\"#树上启发式合并\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>众所周知并查集有两种优化方式，一种是路径压缩，一种是按秩合并，那么在按秩合并的过程中，每次我们会把大小较小的集合合并到较大的集合中，这看上去很暴力，但是它的复杂度就是对的，这是<strong>启发式合并</strong>的思想。</p><p>这种思想在树上问题中会比较常见，当对于每个节点，我们需要合并它所有子节点的答案来得到它本身的答案的时候，经常会用到<strong>树上启发式合并</strong>。</p><hr><section><h2 id=\"例题lomsat-gelral\">例题：<a href=\"https://www.luogu.com.cn/problem/CF600E\">Lomsat gelral</a><a class=\"anchor\" href=\"#例题lomsat-gelral\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2300</mn></mrow><annotation encoding=\"application/x-tex\">2300</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2300</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的有根树，点有点权，对于每棵子树，求出其中点权的所有众数之和。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup><mo separator=\"true\">,</mo><mn>1</mn><mo>≤</mo><mtext>点权</mtext><mo>≤</mo><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">1\\le n\\le 10^5,1\\le \\text{点权}\\le n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0085em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8193em;vertical-align:-0.136em;\"></span><span class=\"mord text\"><span class=\"mord cjk_fallback\">点权</span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>。</p><hr><p>考虑维护每个点权出现的次数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span>，同时不难维护答案，如果直接去合并 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span> 会比较困难。</p><p>可以考虑每个节点都可以继承一个儿子的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span> 数组，然后对于其它的儿子，将那些子树都跑一遍并更新 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span>，只要每次继承子树大小最大的儿子即可，时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>复杂度分析：</p><p>我们考虑只保留每个点到重儿子的边，把其他边都删了，那么维护每一个连通块的答案总复杂度是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 的，接下来考虑重新更新 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span> 的复杂度。</p><p>每次我们更新一次 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">cnt</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span></span></span></span> 就把这个连通块连到父亲上，由于这个连通块不是这个父亲的重儿子，所以连通块大小一定会翻倍，那么对于每个节点，它所在的连通块大小只会翻倍 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 次，所以每个点的更新次数都是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 次，总复杂度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr></section><section><h2 id=\"arpas-letter-marked-tree-and-mehrdads-dokhtar-kosh-paths\"><a href=\"https://www.luogu.com.cn/problem/CF741D\">Arpa’s letter-marked tree and Mehrdad’s Dokhtar-kosh paths</a><a class=\"anchor\" href=\"#arpas-letter-marked-tree-and-mehrdads-dokhtar-kosh-paths\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2900</mn></mrow><annotation encoding=\"application/x-tex\">2900</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2900</span></span></span></span></p><p>给定一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的树，根为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>，每条边上有一个字符（a 到 v 共 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>22</mn></mrow><annotation encoding=\"application/x-tex\">22</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">22</span></span></span></span> 种）。一条简单路径被称为 Dokhtar-kosh，当且仅当路径上的字符经过重新排序后可以变成一个回文串。 求每个子树中最长的 Dokhtar-kosh 路径的长度。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">1\\le n\\le 5\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>首先发现一个字符串能重排成回文串当且仅当有最多一个字符出现了奇数次。</p><p>我们用一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>∼</mo><msup><mn>2</mn><mn>22</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">0\\sim2^{22}-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">22</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 之间的数 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">val_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示一个点到根路径上每种字母出现了奇数次还是偶数次，那么从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 的路径上的信息就是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>x</mi></msub><mi mathvariant=\"normal\">xor</mi><mo>⁡</mo><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">val_x\\operatorname{xor}val_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">xor</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>。</p><p>那么也就是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>x</mi></msub><mi mathvariant=\"normal\">xor</mi><mo>⁡</mo><mi>v</mi><mi>a</mi><msub><mi>l</mi><mi>y</mi></msub></mrow><annotation encoding=\"application/x-tex\">val_x\\operatorname{xor}val_y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\"><span class=\"mord mathrm\">xor</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 等于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span> 或 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>p</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6644em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span></span></span></span></span></span></span></span> 时合法。</p><p>直接用一个数组记录每个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi></mrow><annotation encoding=\"application/x-tex\">val</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span></span></span></span> 在子树内的最大深度，转移这个数组即可，时间复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi mathvariant=\"normal\">∣</mi><mi mathvariant=\"normal\">Σ</mi><mi mathvariant=\"normal\">∣</mi><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(|\\Sigma|n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">∣Σ∣</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr></section></section>\n<section><h1 id=\"树上随机游走\">树上随机游走<a class=\"anchor\" href=\"#树上随机游走\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>一张图的随机游走问题一般复杂度是 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^3)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>，但是由于树的优秀性质，所以在此类问题上复杂度通常为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>有时候，我们可以把走一条路径的贡献拆成其中每一条边的贡献。</p><hr><section><h2 id=\"alices-adventures-in-the-rabbit-hole\"><a href=\"https://www.luogu.com.cn/problem/CF2028E\">Alice’s Adventures in the Rabbit Hole</a><a class=\"anchor\" href=\"#alices-adventures-in-the-rabbit-hole\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2300</mn></mrow><annotation encoding=\"application/x-tex\">2300</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2300</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的树，初始时棋子在节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>，每次有相同的概率选 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi><mo separator=\"true\">,</mo><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">A,B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span> 中的一人操作，操作为将棋子往相邻的一条边移动，若棋子移到根则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 胜，若棋子移到叶子则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span> 胜，若两人都以最优决策操作，对于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>=</mo><mn>1</mn><mo separator=\"true\">,</mo><mn>2</mn><mo separator=\"true\">,</mo><mo>…</mo><mo separator=\"true\">,</mo><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">x=1,2,\\dots,n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>，分别求出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 赢的概率，答案对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>998244353</mn></mrow><annotation encoding=\"application/x-tex\">998244353</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">998244353</span></span></span></span> 取模。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>2</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">2\\le n\\le2\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><p>可以做到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>。</p><hr><p>考虑如果树是一条直链，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 赢的概率是多少？</p><p>实际上等于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mrow><mi>n</mi><mo>−</mo><mi>d</mi><mi>e</mi><msub><mi>p</mi><mi>x</mi></msub></mrow><mi>n</mi></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{n-dep_x}{n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2772em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9322em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.4461em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>。</p><p>那么如果现在对于节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>，在子树中深度最浅的叶子到他的距离为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">len</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span></span></span></span>，那么在不到达叶子的情况下，它能往上走一步的概率为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>l</mi><mi>e</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{len+1}{len}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2251em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8801em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span>，设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>f</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">f_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 处开始 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span> 能赢的概率，则 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>f</mi><mi>x</mi></msub><mo>=</mo><mfrac><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mo>+</mo><mn>1</mn></mrow><mrow><mi>l</mi><mi>e</mi><mi>n</mi></mrow></mfrac><msub><mi>f</mi><mrow><mi>f</mi><msub><mi>a</mi><mi>x</mi></msub></mrow></msub></mrow><annotation encoding=\"application/x-tex\">f_x=\\frac{len+1}{len}f_{fa_x}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.2251em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8801em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">n</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>，直接 dp 即可。</p><hr><p>也有时候，我们不能简单地处理贡献。</p><hr></section><section><h2 id=\"例题random-walk\">例题：<a href=\"https://www.luogu.com.cn/problem/CF1823F\">Random Walk</a><a class=\"anchor\" href=\"#例题random-walk\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2600</mn></mrow><annotation encoding=\"application/x-tex\">2600</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2600</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的树和起点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">s</span></span></span></span>，终点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>，求从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">s</span></span></span></span> 开始随机游走，经过每个点的期望次数，答案对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>998244353</mn></mrow><annotation encoding=\"application/x-tex\">998244353</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">998244353</span></span></span></span> 取模。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>2</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">2\\le n\\le 2\\times10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>我们设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示期望经过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> 点的次数，那么对于除了 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">s</span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> 之外的节点，有：</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><msub><mo>∑</mo><mrow><mo stretchy=\"false\">{</mo><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo stretchy=\"false\">}</mo><mo>∈</mo><mi>E</mi><mo>∧</mo><mi>j</mi><mo mathvariant=\"normal\">≠</mo><mi>t</mi></mrow></msub><mfrac><mrow><mi>d</mi><msub><mi>p</mi><mi>j</mi></msub></mrow><mrow><mi>d</mi><mi>e</mi><msub><mi>g</mi><mi>j</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">dp_i=\\sum_{\\{i,j\\}\\in E\\land j\\neq t}\\frac{dp_j}{deg_j}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.5357em;vertical-align:-0.5423em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2253em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">{</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose mtight\">}</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">E</span><span class=\"mbin mtight\">∧</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\"><span class=\"mrel mtight\"><span class=\"mord vbox mtight\"><span class=\"thinbox mtight\"><span class=\"rlap mtight\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"inner\"><span class=\"mord mtight\"><span class=\"mrel mtight\"></span></span></span><span class=\"fix\"></span></span></span></span></span><span class=\"mrel mtight\">=</span></span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4747em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9934em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2819em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.5073em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2819em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5423em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></p><p>其中 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><msub><mi>g</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">deg_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>j</mi></mrow><annotation encoding=\"application/x-tex\">j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.854em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span></span> 的度数。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>s</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_s</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 是上述的式子加一而 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>t</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">dp_t=1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>。</p><p>发现这个式子没法转移。</p><hr><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><msub><mo>∑</mo><mrow><mo stretchy=\"false\">{</mo><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo stretchy=\"false\">}</mo><mo>∈</mo><mi>E</mi><mo>∧</mo><mi>j</mi><mo mathvariant=\"normal\">≠</mo><mi>t</mi></mrow></msub><mfrac><mrow><mi>d</mi><msub><mi>p</mi><mi>j</mi></msub></mrow><mrow><mi>d</mi><mi>e</mi><msub><mi>g</mi><mi>j</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">dp_i=\\sum_{\\{i,j\\}\\in E\\land j\\neq t}\\frac{dp_j}{deg_j}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.5357em;vertical-align:-0.5423em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∑</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2253em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">{</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mpunct mtight\">,</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose mtight\">}</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">E</span><span class=\"mbin mtight\">∧</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span><span class=\"mrel mtight\"><span class=\"mrel mtight\"><span class=\"mord vbox mtight\"><span class=\"thinbox mtight\"><span class=\"rlap mtight\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"inner\"><span class=\"mord mtight\"><span class=\"mrel mtight\"></span></span></span><span class=\"fix\"></span></span></span></span></span><span class=\"mrel mtight\">=</span></span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4747em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9934em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2819em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.5073em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2819em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5423em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></p><p>重新观察一下这个式子，我们虽然没有办法快速转移这个式子，但是我们可以方便地将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mi>i</mi></msub><mo>×</mo><mi>d</mi><msub><mi>p</mi><mrow><mi>f</mi><msub><mi>a</mi><mi>i</mi></msub></mrow></msub><mo>+</mo><msub><mi>b</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">k_i\\times dp_{fa_i}+b_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的形式。</p><p>首先叶子结点可以直接表示，然后对于每个节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span>，如果它的所有子节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>j</mi></mrow><annotation encoding=\"application/x-tex\">j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.854em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span></span></span></span> 的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 都已经被表示成 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mi>j</mi></msub><mo>×</mo><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub><mo>+</mo><msub><mi>b</mi><mi>j</mi></msub></mrow><annotation encoding=\"application/x-tex\">k_j\\times dp_i+b_j</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05724em;\">j</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span>，那么直接代入到上面的式子里，这个式子就会变成一个只跟 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 和 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mrow><mi>f</mi><msub><mi>a</mi><mi>i</mi></msub></mrow></msub></mrow><annotation encoding=\"application/x-tex\">dp_{fa_i}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> 有关的等式，那么显然可以将 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 表示为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mi>i</mi></msub><mo>×</mo><mi>d</mi><msub><mi>p</mi><mrow><mi>f</mi><msub><mi>a</mi><mi>i</mi></msub></mrow></msub><mo>+</mo><msub><mi>b</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">k_i\\times dp_{fa_i}+b_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9805em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3281em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 的形式。</p><p>发现根节点没有父亲，所以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mrow><mi>r</mi><mi>o</mi><mi>o</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>b</mi><mrow><mi>r</mi><mi>o</mi><mi>o</mi><mi>t</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">dp_{root}=b_{root}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">roo</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">roo</span><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，然后再不断下传即可。</p><hr></section><section><h2 id=\"send-the-fool-further\"><a href=\"https://www.luogu.com.cn/problem/CF802L\">Send the Fool Further!</a><a class=\"anchor\" href=\"#send-the-fool-further\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>Difficulty:<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2400</mn></mrow><annotation encoding=\"application/x-tex\">2400</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2400</span></span></span></span></p><p>给出一棵 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> 个点的带权树，从根开始随机游走直到走到叶子结点，求经过的期望距离，答案对 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>10</mn><mn>9</mn></msup><mo>+</mo><mn>7</mn></mrow><annotation encoding=\"application/x-tex\">10^9+7</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">9</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">7</span></span></span></span> 取模。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding=\"application/x-tex\">3\\le n\\le10^5</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7804em;vertical-align:-0.136em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\">1</span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">5</span></span></span></span></span></span></span></span></span></span></span></p><hr><p>设 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">dp_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为从节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 走到叶子结点的期望距离，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>x</mi></msub></mrow><annotation encoding=\"application/x-tex\">out_x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7651em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> 为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 出边之和。</p><p>显然有：</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><msub><mi>p</mi><mi>x</mi></msub><mo>=</mo><mfrac><mrow><mi>o</mi><mi>u</mi><msub><mi>t</mi><mi>x</mi></msub><mo>+</mo><mi>d</mi><msub><mi>p</mi><mrow><mi>f</mi><msub><mi>a</mi><mi>x</mi></msub></mrow></msub><mo>+</mo><munder><mo>∑</mo><mrow><mi>y</mi><mo>∈</mo><mi>s</mi><mi>o</mi><msub><mi>n</mi><mi>x</mi></msub></mrow></munder><mi>d</mi><msub><mi>p</mi><mi>y</mi></msub></mrow><mrow><mi>d</mi><mi>e</mi><mi>g</mi><mi>r</mi><mi>e</mi><msub><mi>e</mi><mi>x</mi></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">dp_x=\\frac{out_x+dp_{fa_x}+\\sum\\limits_{y\\in son_x}dp_y}{degree_x}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord\"><span class=\"mord mathnormal\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.1189em;vertical-align:-0.4811em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.6378em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span><span class=\"mord mathnormal mtight\">re</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-4.1128em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">u</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mbin mtight\">+</span><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3488em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2306em;\"><span style=\"top:-2.3em;margin-left:0em;margin-right:0.1em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"mord mathnormal mtight\">x</span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2941em;\"><span></span></span></span></span></span></span><span class=\"mbin mtight\">+</span><span class=\"mop op-limits mtight\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.75em;\"><span style=\"top:-1.889em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:2.75em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"mrel mtight\">∈</span><span class=\"mord mathnormal mtight\">so</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2306em;\"><span style=\"top:-2.3em;margin-left:0em;margin-right:0.1em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"mord mathnormal mtight\">x</span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-2.75em;\"><span class=\"pstrut\" style=\"height:2.75em;\"></span><span><span class=\"mop op-symbol small-op mtight\">∑</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1469em;\"><span></span></span></span></span></span><span class=\"mspace mtight\" style=\"margin-right:0.1952em;\"></span><span class=\"mord mathnormal mtight\">d</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">p</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1645em;\"><span style=\"top:-2.357em;margin-left:0em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2819em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.4811em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></p><p>用上一个题的套路处理即可。</p><hr></section></section>\n<section><h1 id=\"树链剖分\">树链剖分<a class=\"anchor\" href=\"#树链剖分\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h1><p>树链剖分的思想及能解决的问题\n树链剖分用于将树分割成若干条链的形式，以维护树上路径的信息。</p><p>具体来说，将整棵树剖分为若干条链，使它组合成线性结构，然后用其他的数据结构维护信息。</p><p>树链剖分（树剖/链剖）有多种形式，如重链剖分，长链剖分 和用于 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Link/cut Tree</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{Link/cut Tree}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Link/cut Tree</span></span></span></span></span> 的剖分（有时被称作「实链剖分」），大多数情况下（没有特别说明时），「树链剖分」都指「重链剖分」。</p><p>重链剖分可以将树上的任意一条路径划分成不超过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 条连续的链，每条链上的点深度互不相同（即是自底向上的一条链，链上所有点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LCA</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{LCA}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">LCA</span></span></span></span></span> 为链的一个端点）。</p><p>重链剖分还能保证划分出的每条链上的节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>dfs</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{dfs}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">dfs</span></span></span></span></span> 序连续，因此可以方便地用一些维护序列的数据结构（如线段树）来维护树上路径的信息。</p><p>如：</p><ul>\n<li>修改 树上两点之间的路径上 所有点的值。</li>\n<li>查询 树上两点之间的路径上 节点权值的 和/极值/其它（在序列上可以用数据结构维护，便于合并的信息）。</li>\n</ul><p>除了配合数据结构来维护树上路径信息，树剖还可以用来 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>（且常数较小）地求 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LCA</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{LCA}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">LCA</span></span></span></span></span>。在某些题目中，还可以利用其性质来灵活地运用树剖。</p><section><h2 id=\"重链剖分\">重链剖分<a class=\"anchor\" href=\"#重链剖分\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>我们给出一些定义：</p><p>定义<strong>重子节点</strong>表示其子节点中子树最大的子结点。如果有多个子树最大的子结点，取其一。如果没有子节点，就无重子节点。</p><p>定义<strong>轻子节点</strong>表示剩余的所有子结点。</p><p>从这个结点到重子节点的边为<strong>重边</strong>。</p><p>到其他轻子节点的边为<strong>轻边</strong>。</p><p>若干条首尾衔接的重边构成<strong>重链</strong>。</p><p>把落单的结点也当作重链，那么整棵树就被剖分成若干条重链。\n<img src=\"https://oi-wiki.org/graph/images/hld.png\" alt=\"\"></p><p>实现\n树剖的实现分两个 DFS 的过程。伪代码如下：</p><p>第一个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 记录每个结点的父节点（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>father</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{father}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">father</span></span></span></span></span>）、深度（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>deep</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{deep}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord text\"><span class=\"mord\">deep</span></span></span></span></span>）、子树大小（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>size</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{size}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6679em;\"></span><span class=\"mord text\"><span class=\"mord\">size</span></span></span></span></span>）、重子节点（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>hson</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{hson}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">hson</span></span></span></span></span>）。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mtable rowspacing=\"0.16em\" columnalign=\"left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mtext>TREE-BUILD </mtext><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mtable rowspacing=\"0.16em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mo>←</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>←</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>d</mi><mi>e</mi><mi>e</mi><mi>p</mi><mo>←</mo><mi>d</mi><mi>e</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>←</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mrow><mtext mathvariant=\"bold\">for</mtext><mtext> </mtext></mrow><mtext>each </mtext><mi>u</mi><mtext>’s son </mtext><mi>v</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>←</mo><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>+</mo><mtext>TREE-BUILD </mtext><mo stretchy=\"false\">(</mo><mi>v</mi><mo separator=\"true\">,</mo><mi>d</mi><mi>e</mi><mi>p</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mi>v</mi><mi mathvariant=\"normal\">.</mi><mi>f</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi><mo>←</mo><mi>u</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mrow><mtext mathvariant=\"bold\">if</mtext><mtext> </mtext></mrow><mi>v</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>></mo><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mspace width=\"2em\"></mspace><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mo>←</mo><mi>v</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mrow><mtext mathvariant=\"bold\">return</mtext><mtext> </mtext></mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{array}{l}\n\\text{TREE-BUILD }(u,dep) \\\\\n\\begin{array}{ll}\n1 &#x26; u.hson\\gets 0 \\\\\n2 &#x26; u.hson.size\\gets 0 \\\\\n3 &#x26; u.deep\\gets dep \\\\\n4 &#x26; u.size\\gets 1 \\\\\n5 &#x26; \\textbf{for }\\text{each }u\\text{'s son }v \\\\\n6 &#x26; \\qquad u.size\\gets u.size + \\text{TREE-BUILD }(v,dep+1) \\\\\n7 &#x26; \\qquad v.father\\gets u \\\\\n8 &#x26; \\qquad \\textbf{if }v.size> u.hson.size \\\\\n9 &#x26; \\qquad \\qquad u.hson\\gets v \\\\\n10 &#x26; \\textbf{return } u.size\n\\end{array}\n\\end{array}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:13.2em;vertical-align:-6.35em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.85em;\"><span style=\"top:-14.26em;\"><span class=\"pstrut\" style=\"height:8.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">TREE-BUILD </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span></span></span><span style=\"top:-7.65em;\"><span class=\"pstrut\" style=\"height:8.25em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.25em;\"><span style=\"top:-8.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span><span style=\"top:-7.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-6.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">3</span></span></span><span style=\"top:-4.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">4</span></span></span><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">5</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">6</span></span></span><span style=\"top:-1.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">7</span></span></span><span style=\"top:-0.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">8</span></span></span><span style=\"top:1.19em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">9</span></span></span><span style=\"top:2.39em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">10</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.75em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.25em;\"><span style=\"top:-8.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">0</span></span></span><span style=\"top:-7.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">0</span></span></span><span style=\"top:-6.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">ee</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-4.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">1</span></span></span><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord textbf\">for </span></span><span class=\"mord text\"><span class=\"mord\">each </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord text\"><span class=\"mord\">’s son </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord text\"><span class=\"mord\">TREE-BUILD </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span><span style=\"top:-1.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">u</span></span></span><span style=\"top:-0.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord textbf\">if </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span></span></span><span style=\"top:1.19em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:2.39em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord textbf\">return </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">ze</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.75em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.35em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span></p><p>第二个 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 记录所在链的链顶（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>top</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{top}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8095em;vertical-align:-0.1944em;\"></span><span class=\"mord text\"><span class=\"mord\">top</span></span></span></span></span>，应初始化为结点本身）、重边优先遍历时的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>dfn</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{dfn}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">dfn</span></span></span></span></span>）、<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序对应的节点编号（<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>rank</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{rank}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">rank</span></span></span></span></span>）。</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mtable rowspacing=\"0.16em\" columnalign=\"left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mtext>TREE-DECOMPOSITION </mtext><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>t</mi><mi>o</mi><mi>p</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mtable rowspacing=\"0.16em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi><mo>←</mo><mi>t</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mo>←</mo><mi>t</mi><mi>o</mi><mi>t</mi><mo>+</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>d</mi><mi>f</mi><mi>n</mi><mo>←</mo><mi>t</mi><mi>o</mi><mi>t</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>r</mi><mi>a</mi><mi>n</mi><mi>k</mi><mo stretchy=\"false\">(</mo><mi>t</mi><mi>o</mi><mi>t</mi><mo stretchy=\"false\">)</mo><mo>←</mo><mi>u</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mrow><mtext mathvariant=\"bold\">if</mtext><mtext> </mtext></mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mtext> is not </mtext><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mtext>TREE-DECOMPOSITION </mtext><mo stretchy=\"false\">(</mo><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi><mo separator=\"true\">,</mo><mi>t</mi><mi>o</mi><mi>p</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mrow><mtext mathvariant=\"bold\">for</mtext><mtext> </mtext></mrow><mtext>each </mtext><mi>u</mi><mtext>’s son </mtext><mi>v</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mspace width=\"2em\"></mspace><mrow><mtext mathvariant=\"bold\">if</mtext><mtext> </mtext></mrow><mi>v</mi><mtext> is not </mtext><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>h</mi><mi>s</mi><mi>o</mi><mi>n</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mspace width=\"2em\"></mspace><mspace width=\"2em\"></mspace><mtext>TREE-DECOMPOSITION </mtext><mo stretchy=\"false\">(</mo><mi>v</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{array}{l}\n\\text{TREE-DECOMPOSITION }(u,top) \\\\\n\\begin{array}{ll}\n1 &#x26; u.top\\gets top \\\\\n2 &#x26; tot\\gets tot+1\\\\\n3 &#x26; u.dfn\\gets tot \\\\\n4 &#x26; rank(tot)\\gets u \\\\\n5 &#x26; \\textbf{if }u.hson\\text{ is not }0 \\\\\n6 &#x26; \\qquad \\text{TREE-DECOMPOSITION }(u.hson,top) \\\\\n7 &#x26; \\qquad \\textbf{for }\\text{each }u\\text{'s son }v \\\\\n8 &#x26; \\qquad \\qquad \\textbf{if }v\\text{ is not }u.hson \\\\\n9 &#x26; \\qquad \\qquad \\qquad \\text{TREE-DECOMPOSITION }(v,v) \n\\end{array}\n\\end{array}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:12em;vertical-align:-5.75em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:6.25em;\"><span style=\"top:-13.06em;\"><span class=\"pstrut\" style=\"height:7.65em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">TREE-DECOMPOSITION </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span></span></span><span style=\"top:-7.05em;\"><span class=\"pstrut\" style=\"height:7.65em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.65em;\"><span style=\"top:-7.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span><span style=\"top:-6.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-5.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">3</span></span></span><span style=\"top:-4.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">4</span></span></span><span style=\"top:-3.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">5</span></span></span><span style=\"top:-1.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">6</span></span></span><span style=\"top:-0.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">7</span></span></span><span style=\"top:0.59em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">8</span></span></span><span style=\"top:1.79em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">9</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.15em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.65em;\"><span style=\"top:-7.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-6.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">1</span></span></span><span style=\"top:-5.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">df</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-4.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">ank</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">u</span></span></span><span style=\"top:-3.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord textbf\">if </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mord text\"><span class=\"mord\"> is not </span></span><span class=\"mord\">0</span></span></span><span style=\"top:-1.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord\">TREE-DECOMPOSITION </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mclose\">)</span></span></span><span style=\"top:-0.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord textbf\">for </span></span><span class=\"mord text\"><span class=\"mord\">each </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord text\"><span class=\"mord\">’s son </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:0.59em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord textbf\">if </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord text\"><span class=\"mord\"> is not </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span></span></span><span style=\"top:1.79em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord\">TREE-DECOMPOSITION </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">)</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.15em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.75em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span></p><p>以下为代码实现。</p><p>我们先给出一些定义：</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>a</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">fa[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">a</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 在树上的父亲。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">dep[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 在树上的深度。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>i</mi><mi>z</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">siz[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 的子树的节点个数。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>o</mi><mi>n</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">son[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 的 重儿子。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>o</mi><mi>p</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">top[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 所在 重链 的顶部节点（深度最小）。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>f</mi><mi>n</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">dfn[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">df</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示节点 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span>  序，也是其在线段树中的编号。\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mi>n</mi><mi>k</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">rnk[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span> 表示 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序所对应的节点编号，有 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mi>n</mi><mi>k</mi><mo stretchy=\"false\">[</mo><mi>d</mi><mi>f</mi><mi>n</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo><mo stretchy=\"false\">]</mo><mo>=</mo><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">rnk[dfn[x]]=x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">df</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]]</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span>。\n我们进行两遍 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span>  预处理出这些值，其中第一次 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 求出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>a</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">fa[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">a</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>e</mi><mi>p</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">dep[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>i</mi><mi>z</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">siz[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>o</mi><mi>n</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">son[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，第二次 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span>  求出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>o</mi><mi>p</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">top[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mi>f</mi><mi>n</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">dfn[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">df</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mi>n</mi><mi>k</mi><mo stretchy=\"false\">[</mo><mi>x</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">rnk[x]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">nk</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">]</span></span></span></span>。</p><div class=\"expressive-code\"><link rel=\"stylesheet\" href=\"/_astro/ec.d1dr8.css\"><script type=\"module\" src=\"/_astro/ec.qopfj.js\"></script><figure class=\"frame\"><figcaption class=\"header\"></figcaption><pre data-language=\"cpp\" class=\"wrap\" style=\"--ecMaxLine:65ch\"><code><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">1</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">o</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">2</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">  </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">son[o]</span><span style=\"--0:#F97583;--1:#F97583\">=-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,siz[o]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">3</div></div><div class=\"code\"><span class=\"indent\">  </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> j</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">h[o];j; j </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> nxt[j])</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">4</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (</span><span style=\"--0:#F97583;--1:#F97583\">!</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[p[j]]) {</span></div></div><div class=\"ec-line\" style=\"--ecIndent:6ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">5</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">      </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[p[j]] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> dep[o] </span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:6ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">6</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">      </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">fa[p[j]] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> o;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:6ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">7</div></div><div class=\"code\"><span class=\"indent\">      </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p[j]);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:6ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">8</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">      </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">siz[o] </span><span style=\"--0:#F97583;--1:#F97583\">+=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> siz[p[j]];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:6ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">9</div></div><div class=\"code\"><span class=\"indent\">      </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (son[o] </span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">||</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> siz[p[j]] </span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> siz[son[o]]) son[o] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> p[j];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">10</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">11</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">12</div></div><div class=\"code\">\n</div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">13</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">o</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">, </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">t</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">) {</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">14</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">  </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">top[o] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> t;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">15</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">  </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">cnt</span><span style=\"--0:#F97583;--1:#F97583\">++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">16</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">  </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dfn[o] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> cnt;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">17</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">  </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">rnk[cnt] </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> o;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">18</div></div><div class=\"code\"><span class=\"indent\">  </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (son[o] </span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">) </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">19</div></div><div class=\"code\"><span class=\"indent\">  </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(son[o], t);</span><span style=\"--0:#99A0A6;--1:#99A0A6\">  // 优先对重儿子进行 DFS，可以保证同一条重链上的点 DFS 序连续</span></div></div><div class=\"ec-line\" style=\"--ecIndent:2ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">20</div></div><div class=\"code\"><span class=\"indent\">  </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> j </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> h[o]; j; j </span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> nxt[j])</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">21</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (p[j] </span><span style=\"--0:#F97583;--1:#F97583\">!=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> son[o] </span><span style=\"--0:#F97583;--1:#F97583\">&#x26;&#x26;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> p[j] </span><span style=\"--0:#F97583;--1:#F97583\">!=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> fa[o]) </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p[j], p[j]);</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">22</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div></code><button class=\"copy-btn\" aria-label=\"Copy code\"><div class=\"copy-btn-icon\"><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon copy-icon\"><path d=\"M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z\"></path></svg><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon success-icon\"><path d=\"m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z\"></path></svg></div></button></pre></figure></div><section><h3 id=\"重链剖分的性质\">重链剖分的性质<a class=\"anchor\" href=\"#重链剖分的性质\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h3><p>树上每个节点都属于且仅属于一条重链。</p><p>重链开头的结点不一定是重子节点（因为重边是对于每一个结点都有定义的）。</p><p>所有的重链将整棵树<strong>完全剖分</strong>。</p><p>在剖分时 重边优先遍历，最后树的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序上，重链内的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序是连续的。按 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFN</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFN}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFN</span></span></span></span></span> 排序后的序列即为剖分后的链。</p><p>一颗子树内的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序是连续的。</p><p>可以发现，当我们向下经过一条<strong>轻边</strong>时，所在子树的大小至少会 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>÷</mo><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">\\div 2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">÷</span><span class=\"mord\">2</span></span></span></span>。</p><p>因此，对于树上的任意一条路径，把它拆分成从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LCA</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{LCA}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">LCA</span></span></span></span></span> 分别向两边往下走，分别最多走 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 次，因此，树上的每条路径都可以被拆分成不超过 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span> 条重链。</p><p>用树链剖分求树上两点路径权值和，伪代码如下：</p><p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mtable rowspacing=\"0.16em\" columnalign=\"left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mtext>TREE-PATH-SUM </mtext><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mtable rowspacing=\"0.16em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mo>←</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mrow><mtext mathvariant=\"bold\">while</mtext><mtext> </mtext></mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi><mtext> is not </mtext><mi>v</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mrow><mtext mathvariant=\"bold\">if</mtext><mtext> </mtext></mrow><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant=\"normal\">.</mi><mi>d</mi><mi>e</mi><mi>e</mi><mi>p</mi><mo>&#x3C;</mo><mi>v</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant=\"normal\">.</mi><mi>d</mi><mi>e</mi><mi>e</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mspace width=\"2em\"></mspace><mtext>SWAP</mtext><mo stretchy=\"false\">(</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>v</mi><mo stretchy=\"false\">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mi>t</mi><mi>o</mi><mi>t</mi><mo>←</mo><mi>t</mi><mi>o</mi><mi>t</mi><mo>+</mo><mtext>sum of values between </mtext><mi>u</mi><mtext> and </mtext><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mspace width=\"2em\"></mspace><mi>u</mi><mo>←</mo><mi>u</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant=\"normal\">.</mi><mi>f</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mo>←</mo><mi>t</mi><mi>o</mi><mi>t</mi><mo>+</mo><mtext>sum of values between </mtext><mi>u</mi><mtext> and </mtext><mi>v</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mrow><mrow><mtext mathvariant=\"bold\">return</mtext><mtext> </mtext></mrow><mi>t</mi><mi>o</mi><mi>t</mi></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{array}{l}\n\\text{TREE-PATH-SUM }(u,v) \\\\\n\\begin{array}{ll}\n1 &#x26; tot\\gets 0 \\\\\n2 &#x26; \\textbf{while }u.top\\text{ is not }v.top \\\\\n3 &#x26; \\qquad \\textbf{if }u.top.deep&#x3C; v.top.deep \\\\\n4 &#x26; \\qquad \\qquad \\text{SWAP}(u, v) \\\\\n5 &#x26; \\qquad tot\\gets tot + \\text{sum of values between }u\\text{ and }u.top \\\\\n6 &#x26; \\qquad u\\gets u.top.father \\\\\n7 &#x26; tot\\gets tot + \\text{sum of values between }u\\text{ and }v \\\\\n8 &#x26; \\textbf{return } tot \n\\end{array}\n\\end{array}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:10.8em;vertical-align:-5.15em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.65em;\"><span style=\"top:-11.86em;\"><span class=\"pstrut\" style=\"height:7.05em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">TREE-PATH-SUM </span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">)</span></span></span><span style=\"top:-6.45em;\"><span class=\"pstrut\" style=\"height:7.05em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.05em;\"><span style=\"top:-7.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span><span style=\"top:-6.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-4.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">3</span></span></span><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">4</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">5</span></span></span><span style=\"top:-1.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">6</span></span></span><span style=\"top:-0.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">7</span></span></span><span style=\"top:1.19em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">8</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.55em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.05em;\"><span style=\"top:-7.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\">0</span></span></span><span style=\"top:-6.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord textbf\">while </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord text\"><span class=\"mord\"> is not </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-4.81em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord textbf\">if </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">ee</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">ee</span><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-3.61em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord text\"><span class=\"mord\">SWAP</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">)</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord text\"><span class=\"mord\">sum of values between </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord text\"><span class=\"mord\"> and </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span></span></span><span style=\"top:-1.21em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mspace\" style=\"margin-right:2em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">p</span><span class=\"mord\">.</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span></span></span><span style=\"top:-0.01em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">←</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord text\"><span class=\"mord\">sum of values between </span></span><span class=\"mord mathnormal\">u</span><span class=\"mord text\"><span class=\"mord\"> and </span></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span><span style=\"top:1.19em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord textbf\">return </span></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.55em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.15em;\"><span></span></span></span></span></span><span class=\"arraycolsep\" style=\"width:0.5em;\"></span></span></span></span></span></span></p><p>链上的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序是连续的，可以使用线段树、树状数组维护。</p><p>每次选择深度较大的链往上跳，直到两点在同一条链上。</p><p>同样的跳链结构适用于维护、统计路径上的其他信息。</p><p>子树维护\n有时会要求，维护子树上的信息，譬如将以 x 为根的子树的所有结点的权值增加 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi></mrow><annotation encoding=\"application/x-tex\">v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span></span></span></span>。</p><p>在 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 搜索的时候，子树中的结点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>DFS</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{DFS}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">DFS</span></span></span></span></span> 序是连续的。</p><p>每一个结点记录 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi><mi>o</mi><mi>t</mi><mi>t</mi><mi>o</mi><mi>m</mi></mrow><annotation encoding=\"application/x-tex\">bottom</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">tt</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">m</span></span></span></span> 表示所在子树连续区间末端的结点。</p><p>这样就把子树信息转化为连续的一段区间信息。</p><p>求最近公共祖先\n不断向上跳重链，当跳到同一条重链上时，深度较小的结点即为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>LCA</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{LCA}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord text\"><span class=\"mord\">LCA</span></span></span></span></span>。</p><p>向上跳重链时需要先跳所在重链顶端深度较大的那个。</p><div class=\"expressive-code\"><figure class=\"frame\"><figcaption class=\"header\"></figcaption><pre data-language=\"cpp\" class=\"wrap\" style=\"--ecMaxLine:49ch\"><code><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">1</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">lca</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">u</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">v</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">2</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(top[u]</span><span style=\"--0:#F97583;--1:#F97583\">!=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">top[v]){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">3</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(dep[top[u]]</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[top[v]]) u</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">fa[top[u]];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">4</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">else</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> v</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">fa[top[v]];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">5</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">6</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> dep[u]</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[v]</span><span style=\"--0:#F97583;--1:#F97583\">?</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">v</span><span style=\"--0:#F97583;--1:#F97583\">:</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">u;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">7</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div></code><button class=\"copy-btn\" aria-label=\"Copy code\"><div class=\"copy-btn-icon\"><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon copy-icon\"><path d=\"M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z\"></path></svg><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon success-icon\"><path d=\"m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z\"></path></svg></div></button></pre></figure></div></section></section><section><h2 id=\"长链剖分\">长链剖分<a class=\"anchor\" href=\"#长链剖分\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>长链剖分本质上就是另外一种链剖分方式。</p><p>定义 重子节点 表示其子节点中子树深度最大的子结点。如果有多个子树最大的子结点，取其一。如果没有子节点，就无重子节点。</p><p>定义<strong>轻子节点</strong>表示剩余的子结点。</p><p>从这个结点到重子节点的边为<strong>重边</strong>。</p><p>到其他轻子节点的边为<strong>轻边</strong>。</p><p>若干条首尾衔接的重边构成<strong>重链</strong>。</p><p>把落单的结点也当作重链，那么整棵树就被剖分成若干条重链。</p><p>如图（这种剖分方式既可以看成重链剖分也可以看成长链剖分）：\n<img src=\"https://oi-wiki.org/graph/images/hld.png\" alt=\"\">\n长链剖分实现方式和重链剖分类似，这里就不再展开。</p><section><h3 id=\"长链剖分求-k-级祖先\">长链剖分求 k 级祖先<a class=\"anchor\" href=\"#长链剖分求-k-级祖先\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h3><p>即询问一个点向父亲跳 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 次跳到的节点。</p><p>首先我们假设我们已经预处理了每一个节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 级祖先。</p><p>现在我们假设我们找到了询问节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 级祖先满足 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><mi>k</mi><mo>&#x3C;</mo><msup><mn>2</mn><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">2^i \\le k &#x3C; 2^{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span>。</p><p>我们考虑求出其所在重链的节点并且按照深度列入表格。假设重链长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span>。</p><p>同时我们在预处理的时候找到每条重链的根节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span> 级祖先，同样放入表格。</p><p>根据长链剖分的性质，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>−</mo><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">k-2^i \\le 2^i \\leq d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span>, 也就是说，我们可以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 在这条重链的表格上求出的这个节点的 k 级祖先。</p><p>预处理需要倍增出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 次级祖先，同时需要预处理每条重链对应的表格。</p><p>预处理复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>, 询问复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>。</p></section><section><h3 id=\"luogu-p3384-模板重链剖分树链剖分\"><em><a href=\"https://www.luogu.com.cn/problem/P3384\">Luogu P3384 【模板】重链剖分/树链剖分</a></em><a class=\"anchor\" href=\"#luogu-p3384-模板重链剖分树链剖分\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h3><p>如题，已知一棵包含 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span> 个结点的树（连通且无环），每个节点上包含一个数值，需要支持以下操作：</p><ul>\n<li>\n<p><code>1 x y z</code>，表示将树从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 结点最短路径上所有节点的值都加上 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>z</mi></mrow><annotation encoding=\"application/x-tex\">z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span></span></span></span>。</p>\n</li>\n<li>\n<p><code>2 x y</code>，表示求树从 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> 结点最短路径上所有节点的值之和。</p>\n</li>\n<li>\n<p><code>3 x z</code>，表示将以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 为根节点的子树内所有节点值都加上 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>z</mi></mrow><annotation encoding=\"application/x-tex\">z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span></span></span></span>。</p>\n</li>\n<li>\n<p><code>4 x</code> 表示求以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span> 为根节点的子树内所有节点值之和。</p>\n</li>\n</ul><p><strong>Code</strong></p><div class=\"expressive-code\"><figure class=\"frame\" style=\"--lnWidth:3ch\"><figcaption class=\"header\"></figcaption><pre data-language=\"cpp\" class=\"wrap\" style=\"--ecMaxLine:88ch\"><code><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">1</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">#include</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">&#x3C;bits/stdc++.h></span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">2</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">using</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">namespace</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">std</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">3</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> N</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">e</span><span style=\"--0:#79B8FF;--1:#79B8FF\">5</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#79B8FF;--1:#79B8FF\">5</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">4</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">struct</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">E</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> to,next;}edge[N</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">];</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">5</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> n,m,rt,mod,w[N],a[N],head[N],cnt;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">6</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">add</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">u</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">v</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">7</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[</span><span style=\"--0:#F97583;--1:#F97583\">++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">cnt].next</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">head[u];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">8</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[cnt].to</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">v;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">9</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">head[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">cnt;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">10</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">11</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">namespace</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">rw</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">12</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">13</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> tot</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,t</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span><span style=\"--0:#F97583;--1:#F97583\">char</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> ch</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">getchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">14</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(ch</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'0'</span><span style=\"--0:#F97583;--1:#F97583\">||</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">ch</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'9'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(ch</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'-'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">) t</span><span style=\"--0:#F97583;--1:#F97583\">=-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;ch</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">getchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">15</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(ch</span><span style=\"--0:#F97583;--1:#F97583\">>=</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'0'</span><span style=\"--0:#F97583;--1:#F97583\">&#x26;&#x26;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">ch</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'9'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){tot</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tot</span><span style=\"--0:#F97583;--1:#F97583\">*</span><span style=\"--0:#79B8FF;--1:#79B8FF\">10</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">ch</span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'0'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;ch</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">getchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">16</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> tot</span><span style=\"--0:#F97583;--1:#F97583\">*</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">t;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">17</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">18</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">write</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">x</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">19</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">) </span><span style=\"--0:#B392F0;--1:#B392F0\">putchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'-'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">),x</span><span style=\"--0:#F97583;--1:#F97583\">=-</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">x;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">20</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">static</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> sta[</span><span style=\"--0:#79B8FF;--1:#79B8FF\">35</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">];</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> top</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">21</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">do</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{sta[top</span><span style=\"--0:#F97583;--1:#F97583\">++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">x</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#79B8FF;--1:#79B8FF\">10</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,x</span><span style=\"--0:#F97583;--1:#F97583\">/=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">10</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;}</span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">22</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(top) </span><span style=\"--0:#B392F0;--1:#B392F0\">putchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(sta[</span><span style=\"--0:#F97583;--1:#F97583\">--</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">top]</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'0'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">23</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">24</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">file</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">25</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">freopen</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">\".in\"</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">\"r\"</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,stdin);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">26</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">freopen</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">\".out\"</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">\"w\"</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,stdout);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">27</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">28</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">print</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">x</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">char</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">ch</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> (</span><span style=\"--0:#B392F0;--1:#B392F0\">write</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x),</span><span style=\"--0:#B392F0;--1:#B392F0\">putchar</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(ch)),</span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">29</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span><span style=\"--0:#F97583;--1:#F97583\">using</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">namespace</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">rw</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">30</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">namespace</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">31</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">struct</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">node</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> l,r,sum,size,tag;}tree[N</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">32</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">pushup</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){tree[p].sum</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">].sum</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">|</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">].sum)</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">33</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">maketag</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">num</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">34</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].sum</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p].sum</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].size</span><span style=\"--0:#F97583;--1:#F97583\">*</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">num)</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">35</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].tag</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p].tag</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">num)</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">36</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">37</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">pushdown</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">38</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p].tag){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">39</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">maketag</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,tree[p].tag),</span><span style=\"--0:#B392F0;--1:#B392F0\">maketag</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">|</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,tree[p].tag);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">40</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">            </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].tag</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">41</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">42</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">43</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">build</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">l</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">r</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">44</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].l</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">l,tree[p].r</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r,tree[p].size</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r</span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">l</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">45</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r) </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> tree[p].sum</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">w[l]</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod,</span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">46</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> mid</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r)</span><span style=\"--0:#F97583;--1:#F97583\">>></span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">47</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">build</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,l,mid);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">48</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">build</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">|</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,mid</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,r);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">49</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">pushup</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">50</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">51</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">l</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">r</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">num</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">52</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].l</span><span style=\"--0:#F97583;--1:#F97583\">&#x26;&#x26;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].r</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r) </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">maketag</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p,num),</span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">53</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">pushdown</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p);</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> mid</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p].l</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].r)</span><span style=\"--0:#F97583;--1:#F97583\">>></span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">54</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mid) </span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,l,r,num);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">55</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(r</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mid) </span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">|</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,l,r,num);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">56</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">pushup</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">57</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">58</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">p</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">l</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">r</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">59</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].l</span><span style=\"--0:#F97583;--1:#F97583\">&#x26;&#x26;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].r</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">r) </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> tree[p].sum;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">60</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">pushdown</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p);</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> mid</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(tree[p].l</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">tree[p].r)</span><span style=\"--0:#F97583;--1:#F97583\">>></span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">61</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(l</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mid) res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(res</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,l,r))</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">62</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(r</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mid) res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(res</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(p</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;&#x3C;</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#F97583;--1:#F97583\">|</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,l,r))</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">63</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> res;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">64</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">65</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">66</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">namespace</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">{</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">67</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> dep[N],siz[N],fa[N],son[N],dfn[N],top[N],idx;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">68</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">u</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">f</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">69</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[f]</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;siz[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;fa[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">f;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">70</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> maxn</span><span style=\"--0:#F97583;--1:#F97583\">=-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">71</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">head[u];i;i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[i].next){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">72</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> v</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[i].to;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">73</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(f</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">v) </span><span style=\"--0:#F97583;--1:#F97583\">continue</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">74</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(v,u);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">75</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">            </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">siz[u]</span><span style=\"--0:#F97583;--1:#F97583\">+=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">siz[v];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">76</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(siz[son[u]]</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">siz[v]) son[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">v;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">77</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">78</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">79</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">u</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">const</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">f</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">80</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dfn[u]</span><span style=\"--0:#F97583;--1:#F97583\">=++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">idx,w[idx]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">a[u],top[u]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">f;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">81</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">!</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">son[u]) </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(son[u],f);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">82</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">head[u];i;i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[i].next){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">83</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> v</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">edge[i].to;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">84</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">!</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dfn[v]) </span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(v,v);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">85</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">86</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">87</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">x</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">y</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">num</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">88</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(top[x]</span><span style=\"--0:#F97583;--1:#F97583\">!=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">top[y]){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">89</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(dep[top[x]]</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[top[y]]) </span><span style=\"--0:#B392F0;--1:#B392F0\">swap</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">90</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,dfn[top[x]],dfn[x],num);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">91</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">            </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">fa[top[x]];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">92</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">93</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(dep[x]</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[y]) </span><span style=\"--0:#B392F0;--1:#B392F0\">swap</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">94</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,dfn[x],dfn[y],num);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">95</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">96</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">x</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#FFAB70;--1:#FFAB70\">y</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">97</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">98</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(top[x]</span><span style=\"--0:#F97583;--1:#F97583\">!=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">top[y]){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">99</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(dep[top[x]]</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[top[y]]) </span><span style=\"--0:#B392F0;--1:#B392F0\">swap</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">100</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">            </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(res</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,dfn[top[x]],dfn[x]))</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">101</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">            </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">fa[top[x]];</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">102</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">103</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(dep[x]</span><span style=\"--0:#F97583;--1:#F97583\">></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">dep[y]) </span><span style=\"--0:#B392F0;--1:#B392F0\">swap</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">104</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">res</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(res</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,dfn[x],dfn[y]))</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">105</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> res;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">106</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">107</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">inline</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#F97583;--1:#F97583\">void</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">init</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(){</span><span style=\"--0:#B392F0;--1:#B392F0\">dfs1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(rt,</span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span><span style=\"--0:#B392F0;--1:#B392F0\">dfs2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(rt,rt);}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">108</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">109</div></div><div class=\"code\"><span style=\"--0:#F97583;--1:#F97583\">signed</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#B392F0;--1:#B392F0\">main</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">110</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">n</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),m</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),rt</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),mod</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">111</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;i</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;=</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">n;i</span><span style=\"--0:#F97583;--1:#F97583\">++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">) a[i]</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">112</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">for</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> i</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;i</span><span style=\"--0:#F97583;--1:#F97583\">&#x3C;</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">n;i</span><span style=\"--0:#F97583;--1:#F97583\">++</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">113</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> u</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),v</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">114</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#B392F0;--1:#B392F0\">add</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(u,v),</span><span style=\"--0:#B392F0;--1:#B392F0\">add</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(v,u);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">115</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">116</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">init</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">build</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,n);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">117</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">while</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(m</span><span style=\"--0:#F97583;--1:#F97583\">--</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">118</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> op</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">119</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(op</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">120</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),y</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),z</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">()</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">121</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y,z);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">122</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">123</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(op</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#79B8FF;--1:#79B8FF\">2</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">124</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),y</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">125</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">print</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(x,y),</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'</span><span style=\"--0:#79B8FF;--1:#79B8FF\">\\n</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">126</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">127</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(op</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#79B8FF;--1:#79B8FF\">3</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">128</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(),z</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">()</span><span style=\"--0:#F97583;--1:#F97583\">%</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">mod;</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">129</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">update</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::dfn[x],</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::dfn[x]</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::siz[x]</span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,z);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">130</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">131</div></div><div class=\"code\"><span class=\"indent\">        </span><span style=\"--0:#F97583;--1:#F97583\">if</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(op</span><span style=\"--0:#F97583;--1:#F97583\">==</span><span style=\"--0:#79B8FF;--1:#79B8FF\">4</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">){</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">132</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#F97583;--1:#F97583\">int</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> x</span><span style=\"--0:#F97583;--1:#F97583\">=</span><span style=\"--0:#B392F0;--1:#B392F0\">read</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">();</span></div></div><div class=\"ec-line\" style=\"--ecIndent:12ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">133</div></div><div class=\"code\"><span class=\"indent\">            </span><span style=\"--0:#B392F0;--1:#B392F0\">print</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#B392F0;--1:#B392F0\">SGT</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::</span><span style=\"--0:#B392F0;--1:#B392F0\">ask</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">(</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">,</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::dfn[x],</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::dfn[x]</span><span style=\"--0:#F97583;--1:#F97583\">+</span><span style=\"--0:#B392F0;--1:#B392F0\">HLD</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">::siz[x]</span><span style=\"--0:#F97583;--1:#F97583\">-</span><span style=\"--0:#79B8FF;--1:#79B8FF\">1</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">),</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'</span><span style=\"--0:#79B8FF;--1:#79B8FF\">\\n</span><span style=\"--0:#9ECBFF;--1:#9ECBFF\">'</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">);</span></div></div><div class=\"ec-line\" style=\"--ecIndent:8ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">134</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">        </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">135</div></div><div class=\"code\"><span class=\"indent\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">    </span></span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div><div class=\"ec-line\" style=\"--ecIndent:4ch\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">136</div></div><div class=\"code\"><span class=\"indent\">    </span><span style=\"--0:#F97583;--1:#F97583\">return</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\"> </span><span style=\"--0:#79B8FF;--1:#79B8FF\">0</span><span style=\"--0:#E1E4E8;--1:#E1E4E8\">;</span></div></div><div class=\"ec-line\"><div class=\"gutter\"><div class=\"ln\" aria-hidden=\"true\">137</div></div><div class=\"code\"><span style=\"--0:#E1E4E8;--1:#E1E4E8\">}</span></div></div></code><button class=\"copy-btn\" aria-label=\"Copy code\"><div class=\"copy-btn-icon\"><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon copy-icon\"><path d=\"M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z\"></path></svg><svg viewBox=\"0 -960 960 960\" xmlns=\"http://www.w3.org/2000/svg\" class=\"copy-btn-icon success-icon\"><path d=\"m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z\"></path></svg></div></button></pre></figure></div></section></section><section><h2 id=\"长链剖分-1\">长链剖分<a class=\"anchor\" href=\"#长链剖分-1\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h2><p>长链剖分本质上就是另外一种链剖分方式。</p><p>定义 重子节点 表示其子节点中子树深度最大的子结点。如果有多个子树最大的子结点，取其一。如果没有子节点，就无重子节点。</p><p>定义<strong>轻子节点</strong>表示剩余的子结点。</p><p>从这个结点到重子节点的边为<strong>重边</strong>。</p><p>到其他轻子节点的边为<strong>轻边</strong>。</p><p>若干条首尾衔接的重边构成<strong>重链</strong>。</p><p>把落单的结点也当作重链，那么整棵树就被剖分成若干条重链。</p><p>如图（这种剖分方式既可以看成重链剖分也可以看成长链剖分）：\n<img src=\"https://oi-wiki.org/graph/images/hld.png\" alt=\"\">\n长链剖分实现方式和重链剖分类似，这里就不再展开。</p><section><h3 id=\"长链剖分求-k-级祖先-1\">长链剖分求 k 级祖先<a class=\"anchor\" href=\"#长链剖分求-k-级祖先-1\"><span class=\"anchor-icon\" data-pagefind-ignore=\"\">#</span></a></h3><p>即询问一个点向父亲跳 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi></mrow><annotation encoding=\"application/x-tex\">k</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span></span></span></span> 次跳到的节点。</p><p>首先我们假设我们已经预处理了每一个节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 级祖先。</p><p>现在我们假设我们找到了询问节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 级祖先满足 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><mi>k</mi><mo>&#x3C;</mo><msup><mn>2</mn><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">2^i \\le k &#x3C; 2^{i+1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7335em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span>。</p><p>我们考虑求出其所在重链的节点并且按照深度列入表格。假设重链长度为 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span>。</p><p>同时我们在预处理的时候找到每条重链的根节点的 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> 到 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span> 级祖先，同样放入表格。</p><p>根据长链剖分的性质，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>k</mi><mo>−</mo><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><msup><mn>2</mn><mi>i</mi></msup><mo>≤</mo><mi>d</mi></mrow><annotation encoding=\"application/x-tex\">k-2^i \\le 2^i \\leq d</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9606em;vertical-align:-0.136em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">d</span></span></span></span>, 也就是说，我们可以 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span> 在这条重链的表格上求出的这个节点的 k 级祖先。</p><p>预处理需要倍增出 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>i</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8247em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span></span></span></span></span></span></span></span> 次级祖先，同时需要预处理每条重链对应的表格。</p><p>预处理复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span>, 询问复杂度 <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>。</p></section></section></section>";

				const frontmatter = {"title":"Tree","published":"2025-06-11T00:00:00.000Z","description":"","image":"","tags":["c++"],"category":"c++","draft":true,"lang":"","minutes":38,"words":7672,"excerpt":"对于一棵树，我们从根节点处开始 dfs，过程中在每个点第一次遇到的时候把它记录下来，就得到了一棵树的 dfs 序，一般记作 dfn。"};
				const file = "/workspaces/xuluhui.github.io/src/content/posts/Tree.md";
				const url = undefined;

				const Content = createComponent((result, _props, slots) => {
					const { layout, ...content } = frontmatter;
					content.file = file;
					content.url = url;

					return renderTemplate`${maybeRenderHead()}${unescapeHTML(html())}`;
				});

export { Content, Content as default, file, frontmatter, url };
